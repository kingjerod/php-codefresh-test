version: '1.0'
steps:
  build_api_image:
    type: build
    description: Build API image
    image_name: ryze/ryze-api
    tag: ${{CF_SHORT_REVISION}}
    working_directory: services/api
    dockerfile: Dockerfile
  build_portal_image:
    type: build
    description: Build API portal image
    image_name: ryze/ryze-portal
    tag: ${{CF_SHORT_REVISION}}
    working_directory: services/portal
    dockerfile: Dockerfile
  build_nginx_image:
    type: build
    description: Build Nginx image
    image_name: ryze/ryze-nginx
    tag: ${{CF_SHORT_REVISION}}
    working_directory: services/nginx
    dockerfile: Dockerfile
  push_api_to_aws_ecr:
    type: push
    description: Pushing API image to AWS ECR
    candidate: ${{build_api_image}}
    tag: ${{CF_SHORT_REVISION}}
    provider: 'ecr'
    registry: ${{AWS_API_REGISTRY}}
    accessKeyId: ${{AWS_ACCESS_KEY}}
    secretAccessKey: ${{AWS_SECRET_KEY}}
    region: ${{AWS_REGION}}
  push_portal_to_aws_ecr:
    type: push
    description: Pushing portal image to AWS ECR
    candidate: ${{build_portal_image}}
    tag: ${{CF_SHORT_REVISION}}
    provider: 'ecr'
    registry: ${{AWS_PORTAL_REGISTRY}}
    accessKeyId: ${{AWS_ACCESS_KEY}}
    secretAccessKey: ${{AWS_SECRET_KEY}}
    region: ${{AWS_REGION}}
  push_nginx_to_aws_ecr:
    type: push
    description: Pushing nginx image to AWS ECR
    candidate: ${{build_portal_image}}
    tag: ${{CF_SHORT_REVISION}}
    provider: 'ecr'
    registry: ${{AWS_NGINX_REGISTRY}}
    accessKeyId: ${{AWS_ACCESS_KEY}}
    secretAccessKey: ${{AWS_SECRET_KEY}}
    region: ${{AWS_REGION}}
